@page "/pages/authentication/forgot-password"
@inject IStringLocalizer<Forgot> L
@attribute [AllowAnonymous]
@using FluentEmail.Core.Models
@using CleanArchitecture.Blazor.Server.UI.Pages.Identity.Users
@using CleanArchitecture.Blazor.Application.Common.ExceptionHandlers

@inherits OwningComponentBase
<PageTitle>@Title</PageTitle>
<AuthorizeView>
    <NotAuthorized Context="Auth">
        <MudText Typo="Typo.h4" GutterBottom="true">@L["Forgot Password?"]</MudText>
        @if (_step == 1)
        {
            <MudText Typo="Typo.subtitle2">@L["Enter the email address linked to your account and you will recieve an email containing a token string to reset your password."]</MudText>
            <MudTextField T="string" @bind-Value="@_emailAddress" Label="@L["E-mail"]" Variant="Variant.Outlined" Class="my-4"></MudTextField>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true" Class="mt-3" Disabled="@(string.IsNullOrEmpty(_emailAddress) || _sending )" OnClick="@(()=>ResetPassword())">
                @if (_sending)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2"> @L["Waiting"]</MudText>
                }
                else
                {
                    <MudText>@L["Reset Password"]</MudText>
                }
            </MudButton>
        }
        else if (_step == 2 && _resetPasswordToken!=string.Empty)
        {
            <MudText Typo="Typo.subtitle2">@L["Enter the token string from the recovery email to set your new password."]</MudText>
            <MudTextField T="string" 
                @bind-Value="@_inputToken" 
                Label="@L["Token String"]"
                      HelperText="@L["The input token string must be equal to the token string in the recovery email"]"
                Variant="Variant.Outlined" 
                Class="my-4"></MudTextField>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true" Class="mt-3" Disabled="@(_inputToken != _resetPasswordToken || _sending )" OnClick="@(()=>SetNewPassword())">
                @if (_sending)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2"> @L["Waiting"]</MudText>
                }
                else
                {
                    <MudText>@L["Set New Password"]</MudText>
                }
            </MudButton>
        }
    </NotAuthorized>
    <Authorized>
        <RedirectToHome></RedirectToHome>
        <MudAlert Severity="MudBlazor.Severity.Info" Class="mt-8 mud-width-full" Style="max-width:500px;">@L["You are already logged in."]</MudAlert>
    </Authorized>
</AuthorizeView>



